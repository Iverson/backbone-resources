/* Backbone.Resources 0.1.0
 * https://github.com/Iverson/backbone-resources
 *
 * Copyright (c) 2014 Alexey Krasman
 * Licensed under the MIT license.
 */

var Resources=function(a,b){var c={},d={},e={},f=window,g=0,h={actions:["index","new"],item_actions:["show","edit"],silent:!1},i=null,j={resources:{defaults:{index:"_resource_"},custom:"_resource_/:action"},items:{defaults:{show:"_resource_/:id"},custom:"_resource_/:id/:action"}};return c.Router=a.Router.extend({constructor:function(){a.Router.prototype.constructor.apply(this,arguments);for(name in this.resources)this._createResource(name,this.resources[name]);for(rout in this.redirects)this._createRedirect(rout,this.redirects[rout])},_routesHandler:function(){var c=a.history.fragment;params=c.split("/"),name=params[0],resource=d[name],view=resource.view,routeMask=params.join("/").replace(name,"_resource_"),invertActionsMap=b.invert(j.resources.defaults),action=null,action=routeMask in invertActionsMap?invertActionsMap[routeMask]:params[1],"function"==typeof view&&(e[name]=e[name]||new view,e[name].action(action,{id:arguments[0]})),this.trigger("route:"+name+":"+action,{id:arguments[0]})},_itemsRoutesHandler:function(){var c=a.history.fragment;params=c.split("/"),name=params[0],resource=d[name],view=resource.view,routeMask=null,invertActionsMap=b.invert(j.items.defaults),action=null,params[1]=":id",routeMask=params.join("/").replace(name,"_resource_"),action=routeMask in invertActionsMap?invertActionsMap[routeMask]:params[2],"function"==typeof view&&(e[name]=e[name]||new view,e[name].action(action,{id:arguments[0]})),this.trigger("route:"+name+":"+action,{id:arguments[0]})},_createResource:function(a,c){switch(typeof c){case"object":i=b.extend(h,c),i.actions=c.actions||h.actions,i.item_actions=c.item_actions||h.item_actions,d[a]={view:i.view,params:i},this._createsResourceRoutes(a,i);break;default:d[a]={view:c,params:h},this._createsResourceRoutes(a,h)}},_createsResourceRoutes:function(a,b){for(var c,d=0;d<b.item_actions.length;d++)c=b.item_actions[d],this._createRoute(a,c,j.items,"_itemsRoutesHandler","item");for(var d=0;d<b.actions.length;d++)c=b.actions[d],this._createRoute(a,c,j.resources,"_routesHandler","collection")},_createRoute:function(a,b,c,d,e){var f;routMask=b in c.defaults?c.defaults[b]:c.custom,f=routMask.replace("_resource_",a).replace(":action",b),this.route(f,d),this._createRouteHelper(a,b,c,f,e)},_createRouteHelper:function(a,b,c,d,e){var g,h=a.slice(0,-1);"item"==e?(g="show"==b?h+"_path":b+"_"+h+"_path",f[g]=function(a){return"#"+d.replace(":id",a)}):(g=g="new"==b?b+"_"+h+"_path":b+"_"+a+"_path",g="index"==b?g=a+"_path":g,f[g]=function(){return"#"+d})},_createRedirect:function(a,b){var c="__redirect__"+g;this[c]=function(){for(var a=/:(\w+)/i,c=0;c<arguments.length;c++)b=b.replace(a,arguments[c]);this.navigate(b,{trigger:!0,replace:!0})},this.route(a,c)}}),c.View=a.View.extend({action:function(a,b){this._runningAction=a,this.template=null,this._actionTemplatePath=this.JSTpath?this.JSTpath+"/"+a:null,"undefined"!=typeof JST&&(this.template=JST[this._actionTemplatePath]),this.params=b,this[a](b),!this.rendered&&this.template&&this.render(),this.rendered=!1,this._runningAction=null},render:function(a){var b=this;return a=a||this.params,"function"==typeof this.template&&this._runningAction&&this.$el.empty().append(this.template(a)).ready(function(){b.rendered=!1}),this.rendered=!0,this},skipRender:function(){this.rendered=!0}}),c}(Backbone,_);